#!/bin/bash

# apt-get install figlet

email="$2"

announce() {
  local msg="$1"
  say "$msg"

  if [[ "$email" ]]
  then
    echo "$msg" | msmpt $email
  fi
}

render() {
  while read remaining
  do
    minutes=$(expr $remaining / 60)
    seconds=$(expr $remaining % 60)
    echo "  ${minutes}m ${seconds}s" | figlet | sed '$d'
    sleep 1
    command clear
  done
}

finally() {
  local reason="$1"
  echo $started $(now) "$(printf '%-8s' $reason)" $task >> "$plogfile"
  notify-send "$reason" >/dev/null
  announce "$reason"
}

now()   {
  echo $(date "+%H:%M:%S");
}

today() {
  echo $(date "+%Y-%m-%d");
}

countdown() {
  local s=$1
  ruby -e "(1..$s).to_a.reverse.each { |i| puts i }" | render
}

brkover() {
  afplay ~/Dropbox/media/power.mp3
}

test "$#" -gt 2 && { echo 2>&1 terser.; exit 2; }

plogfile="$(plog)"
seconds="${seconds:-1500}"
started="$(today) $(now)"
task="$1"
next=$(cat $plogfile 2>/dev/null | grep completed | wc -l | xargs expr 1 +)

trap "finally aborted!; exit 1" SIGINT SIGTERM

if [[ $task == "brk" ]]
then
  countdown 300
  brkover
  exit 0
fi

announce $next
countdown $seconds
finally completed.
